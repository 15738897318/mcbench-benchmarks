%rhsim is the simulink description that is used by rhsta.m	

%  /Program:  rhsim.m							   \
% / Description:  This program is the simulink file for the Rhors example   \
%|  	found in sections 3.2.3 and 3.3.4 of the text.  	 	     |									 |
%|	This program requires the startup file rhsta.m for setup.         |
% \ 	                                                                    /
%  \_______________________________________________________________________/

%Copyright

% Programmed Summer 1996 by Kenyon Thayer, RPI, Troy, NY
	

function [ret,x0,str,ts,xts]=text_rhsim(t,x,u,flag);
%TEXT_RHSIM	is the M-file description of the SIMULINK system named TEXT_RHSIM.
%	The block-diagram can be displayed by typing: TEXT_RHSIM.
%
%	SYS=TEXT_RHSIM(T,X,U,FLAG) returns depending on FLAG certain
%	system values given time point, T, current state vector, X,
%	and input vector, U.
%	FLAG is used to indicate the type of output to be returned in SYS.
%
%	Setting FLAG=1 causes TEXT_RHSIM to return state derivatives, FLAG=2
%	discrete states, FLAG=3 system outputs and FLAG=4 next sample
%	time. For more information and other options see SFUNC.
%
%	Calling TEXT_RHSIM with a FLAG of zero:
%	[SIZES]=TEXT_RHSIM([],[],[],0),  returns a vector, SIZES, which
%	contains the sizes of the state vector and other parameters.
%		SIZES(1) number of states
%		SIZES(2) number of discrete states
%		SIZES(3) number of outputs
%		SIZES(4) number of inputs
%		SIZES(5) number of roots (currently unsupported)
%		SIZES(6) direct feedthrough flag
%		SIZES(7) number of sample times
%
%	For the definition of other parameters in SIZES, see SFUNC.
%	See also, TRIM, LINMOD, LINSIM, EULER, RK23, RK45, ADAMS, GEAR.

% Note: This M-file is only used for saving graphical information;
%       after the model is loaded into memory an internal model
%       representation is used.

% the system will take on the name of this mfile:
sys = mfilename;
new_system(sys)
simver(1.3)
if (0 == (nargin + nargout))
     set_param(sys,'Location',[551,65,1235,541])
     open_system(sys)
end;
set_param(sys,'algorithm',     'Gear')
set_param(sys,'Start time',    '0.0')
set_param(sys,'Stop time',     '40')
set_param(sys,'Min step size', '0.0001')
set_param(sys,'Max step size', '0.01')
set_param(sys,'Relative error','1e-3')
set_param(sys,'Return vars',   '')

add_block('built-in/State-Space',[sys,'/','Reference Model'])
set_param([sys,'/','Reference Model'],...
		'ForeGround',4,...
		'Font Name','Times New Roman',...
		'A','Am',...
		'B','Bm',...
		'C','[Cm;1]',...
		'D','[Dm 0]''',...
		'X0','xm0',...
		'position',[160,70,225,100])

add_block('built-in/Outport',[sys,'/','Um'])
set_param([sys,'/','Um'],...
		'ForeGround',3,...
		'move name',0,...
		'Font Name','Times New Roman',...
		'Port','4',...
		'position',[150,29,170,51])

add_block('built-in/Note',[sys,'/',['Rhor''s Example']])
set_param([sys,'/',['Rhor''s Example']],...
		'Font Name','Times New Roman',...
		'position',[380,5,385,10])


%     Subsystem  'Kx'.

new_system([sys,'/','Kx'])
set_param([sys,'/','Kx'],'Location',[64,94,684,351])

add_block('built-in/Inport',[sys,'/','Kx/in_1 '])
set_param([sys,'/','Kx/in_1 '],...
		'position',[40,85,60,105])

add_block('built-in/Inport',[sys,'/','Kx/in_2'])
set_param([sys,'/','Kx/in_2'],...
		'Port','2',...
		'position',[40,20,60,40])

add_block('built-in/Gain',[sys,'/','Kx/Tie'])
set_param([sys,'/','Kx/Tie'],...
		'Gain','Tix',...
		'position',[240,117,260,143])

add_block('built-in/Integrator',[sys,'/','Kx/Integrator1'])
set_param([sys,'/','Kx/Integrator1'],...
		'Initial','Kx0',...
		'position',[295,115,320,145])

add_block('built-in/Sum',[sys,'/','Kx/Sum3'])
set_param([sys,'/','Kx/Sum3'],...
		'position',[375,55,405,90])

add_block('built-in/Gain',[sys,'/','Kx/Tpe'])
set_param([sys,'/','Kx/Tpe'],...
		'Gain','Tpx',...
		'position',[280,52,305,78])

add_block('built-in/Product',[sys,'/','Kx/Product2'])
set_param([sys,'/','Kx/Product2'],...
		'position',[460,59,485,121])

add_block('built-in/Outport',[sys,'/','Kx/out_2 '])
set_param([sys,'/','Kx/out_2 '],...
		'Port','2',...
		'position',[455,10,475,30])

add_block('built-in/Outport',[sys,'/','Kx/out_1'])
set_param([sys,'/','Kx/out_1'],...
		'position',[540,80,560,100])

add_block('built-in/Product',[sys,'/','Kx/Product'])
set_param([sys,'/','Kx/Product'],...
		'position',[145,45,170,80])
add_line([sys,'/','Kx'],[410,75;455,75])
add_line([sys,'/','Kx'],[490,90;535,90])
add_line([sys,'/','Kx'],[175,65;275,65])
add_line([sys,'/','Kx'],[265,130;290,130])
add_line([sys,'/','Kx'],[310,65;370,65])
add_line([sys,'/','Kx'],[65,95;90,95;90,70;140,70])
add_line([sys,'/','Kx'],[65,30;90,30;90,55;140,55])
add_line([sys,'/','Kx'],[205,65;205,130;235,130])
add_line([sys,'/','Kx'],[325,130;350,130;350,80;370,80])
add_line([sys,'/','Kx'],[420,75;420,20;450,20])
add_line([sys,'/','Kx'],[110,70;110,170;425,170;425,105;455,105])


%     Finished composite block 'Kx'.

set_param([sys,'/','Kx'],...
		'orientation',2,...
		'ForeGround',6,...
		'Font Name','Times New Roman',...
		'position',[330,142,360,193])

add_block('built-in/Outport',[sys,'/','KX'])
set_param([sys,'/','KX'],...
		'orientation',2,...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'Port','5',...
		'position',[265,170,285,190])


%     Subsystem  'Ku'.

new_system([sys,'/','Ku'])
set_param([sys,'/','Ku'],'Location',[36,121,670,388])

add_block('built-in/Product',[sys,'/','Ku/Product1'])
set_param([sys,'/','Ku/Product1'],...
		'position',[165,62,190,113])

add_block('built-in/Gain',[sys,'/','Ku/Tpe'])
set_param([sys,'/','Ku/Tpe'],...
		'Gain','Tpu',...
		'position',[290,80,310,100])

add_block('built-in/Inport',[sys,'/','Ku/in_1'])
set_param([sys,'/','Ku/in_1'],...
		'position',[45,130,65,150])

add_block('built-in/Inport',[sys,'/','Ku/in_2 '])
set_param([sys,'/','Ku/in_2 '],...
		'Port','2',...
		'position',[40,35,60,55])

add_block('built-in/Sum',[sys,'/','Ku/Sum3'])
set_param([sys,'/','Ku/Sum3'],...
		'position',[375,74,405,141])

add_block('built-in/Product',[sys,'/','Ku/Product'])
set_param([sys,'/','Ku/Product'],...
		'position',[480,97,505,153])

add_block('built-in/Outport',[sys,'/','Ku/out_1'])
set_param([sys,'/','Ku/out_1'],...
		'position',[555,115,575,135])

add_block('built-in/Outport',[sys,'/','Ku/out_2 '])
set_param([sys,'/','Ku/out_2 '],...
		'Port','2',...
		'position',[470,30,490,50])

add_block('built-in/Gain',[sys,'/','Ku/Tie'])
set_param([sys,'/','Ku/Tie'],...
		'Gain','Tiu',...
		'position',[245,150,265,170])

add_block('built-in/Integrator',[sys,'/','Ku/Integrator1'])
set_param([sys,'/','Ku/Integrator1'],...
		'Initial','Ku0',...
		'position',[300,150,320,170])
add_line([sys,'/','Ku'],[70,140;90,140;90,100;160,100])
add_line([sys,'/','Ku'],[410,110;475,110])
add_line([sys,'/','Ku'],[65,45;90,45;90,75;160,75])
add_line([sys,'/','Ku'],[510,125;550,125])
add_line([sys,'/','Ku'],[315,90;370,90])
add_line([sys,'/','Ku'],[325,160;350,160;350,125;370,125])
add_line([sys,'/','Ku'],[270,160;295,160])
add_line([sys,'/','Ku'],[195,90;285,90])
add_line([sys,'/','Ku'],[135,100;135,210;450,210;450,140;475,140])
add_line([sys,'/','Ku'],[215,90;215,160;240,160])
add_line([sys,'/','Ku'],[430,110;430,40;465,40])


%     Finished composite block 'Ku'.

set_param([sys,'/','Ku'],...
		'orientation',2,...
		'ForeGround',6,...
		'Font Name','Times New Roman',...
		'position',[120,147,150,198])

add_block('built-in/Outport',[sys,'/','KU'])
set_param([sys,'/','KU'],...
		'orientation',2,...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'Port','6',...
		'position',[75,175,90,195])

add_block('built-in/State-Space',[sys,'/','Plant FFC'])
set_param([sys,'/','Plant FFC'],...
		'ForeGround',2,...
		'Font Name','Times New Roman',...
		'A','Af',...
		'B','Bf',...
		'C','Cf',...
		'D','Df',...
		'X0','xf0',...
		'position',[310,365,385,395])

add_block('built-in/Clock',[sys,'/','Clock'])
set_param([sys,'/','Clock'],...
		'Font Name','Times New Roman',...
		'position',[500,5,520,25])

add_block('built-in/To Workspace',[sys,'/','To Workspace3'])
set_param([sys,'/','To Workspace3'],...
		'Font Name','Times New Roman',...
		'mat-name','t',...
		'buffer','3000',...
		'position',[560,7,610,23])

add_block('built-in/Sum',[sys,'/','S3'])
set_param([sys,'/','S3'],...
		'Font Name','Times New Roman',...
		'position',[510,219,540,266])


%     Subsystem  'Key'.

new_system([sys,'/','Key'])
set_param([sys,'/','Key'],'Location',[42,62,627,348])

add_block('built-in/Product',[sys,'/','Key/Product'])
set_param([sys,'/','Key/Product'],...
		'position',[135,67,170,138])

add_block('built-in/Gain',[sys,'/','Key/Tie'])
set_param([sys,'/','Key/Tie'],...
		'Gain','Tie',...
		'position',[220,167,240,193])

add_block('built-in/Integrator',[sys,'/','Key/Integrator1'])
set_param([sys,'/','Key/Integrator1'],...
		'Initial','Key0',...
		'position',[285,170,305,190])

add_block('built-in/Sum',[sys,'/','Key/Sum3'])
set_param([sys,'/','Key/Sum3'],...
		'position',[370,90,395,150])

add_block('built-in/Outport',[sys,'/','Key/out_1'])
set_param([sys,'/','Key/out_1'],...
		'position',[545,95,565,115])

add_block('built-in/Outport',[sys,'/','Key/out_2 '])
set_param([sys,'/','Key/out_2 '],...
		'Port','2',...
		'position',[485,165,505,185])

add_block('built-in/Product',[sys,'/','Key/Product1'])
set_param([sys,'/','Key/Product1'],...
		'position',[465,74,495,136])

add_block('built-in/Gain',[sys,'/','Key/Tpe'])
set_param([sys,'/','Key/Tpe'],...
		'Gain','Tpe',...
		'position',[265,92,285,118])

add_block('built-in/Inport',[sys,'/','Key/in_1'])
set_param([sys,'/','Key/in_1'],...
		'position',[35,75,55,95])
add_line([sys,'/','Key'],[60,85;130,85])
add_line([sys,'/','Key'],[60,85;60,40;430,40;430,90;460,90])
add_line([sys,'/','Key'],[400,120;460,120])
add_line([sys,'/','Key'],[500,105;540,105])
add_line([sys,'/','Key'],[290,105;365,105])
add_line([sys,'/','Key'],[310,180;330,180;330,135;365,135])
add_line([sys,'/','Key'],[245,180;280,180])
add_line([sys,'/','Key'],[175,105;260,105])
add_line([sys,'/','Key'],[85,85;85,120;130,120])
add_line([sys,'/','Key'],[185,105;185,180;215,180])
add_line([sys,'/','Key'],[420,120;420,175;480,175])


%     Finished composite block 'Key'.

set_param([sys,'/','Key'],...
		'orientation',2,...
		'ForeGround',6,...
		'Font Name','Times New Roman',...
		'position',[435,407,465,458])

add_block('built-in/Outport',[sys,'/','KEy'])
set_param([sys,'/','KEy'],...
		'orientation',2,...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'Port','8',...
		'position',[385,435,405,455])

add_block('built-in/Sum',[sys,'/','S5'])
set_param([sys,'/','S5'],...
		'Font Name','Times New Roman',...
		'inputs','+-',...
		'position',[595,264,625,311])

add_block('built-in/Sum',[sys,'/','S4'])
set_param([sys,'/','S4'],...
		'Font Name','Times New Roman',...
		'position',[510,304,540,351])

add_block('built-in/Outport',[sys,'/','yp'])
set_param([sys,'/','yp'],...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'position',[435,325,450,345])

add_block('built-in/Sum',[sys,'/','S1'])
set_param([sys,'/','S1'],...
		'Font Name','Times New Roman',...
		'inputs','+++',...
		'position',[120,282,155,348])

add_block('built-in/Outport',[sys,'/','up'])
set_param([sys,'/','up'],...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'Port','7',...
		'position',[195,330,210,350])

add_block('built-in/Signal Generator',[sys,'/','Signal Gen.'])
set_param([sys,'/','Signal Gen.'],...
		'ForeGround',2,...
		'Font Name','Times New Roman',...
		'Peak','-0.300000',...
		'Peak Range','1.000000',...
		'Freq','0.315000',...
		'Freq Range','1.016129',...
		'Wave','Sqr',...
		'Units','Rads')
set_param([sys,'/','Signal Gen.'],...
		'position',[45,68,90,102])

add_block('built-in/Outport',[sys,'/','ym'])
set_param([sys,'/','ym'],...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'Port','2',...
		'position',[565,60,580,80])

add_block('built-in/Outport',[sys,'/','xm'])
set_param([sys,'/','xm'],...
		'ForeGround',3,...
		'Font Name','Times New Roman',...
		'Port','3',...
		'position',[425,85,445,105])

add_block('built-in/Demux',[sys,'/','Demux'])
set_param([sys,'/','Demux'],...
		'ForeGround',4,...
		'Font Name','Times New Roman',...
		'outputs','2',...
		'position',[260,59,305,106])

add_block('built-in/Sum',[sys,'/','S2'])
set_param([sys,'/','S2'],...
		'Font Name','Times New Roman',...
		'inputs','-+',...
		'position',[290,236,315,269])

add_block('built-in/State-Space',[sys,'/','Ref. model FFC'])
set_param([sys,'/','Ref. model FFC'],...
		'ForeGround',2,...
		'Font Name','Times New Roman',...
		'A','Af',...
		'B','Bf',...
		'C','Cf',...
		'D','Df',...
		'X0','xf0',...
		'position',[345,240,420,270])

add_block('built-in/Gain',[sys,'/','G1'])
set_param([sys,'/','G1'],...
		'ForeGround',2,...
		'Gain','ff',...
		'position',[460,242,480,268])

add_block('built-in/Gain',[sys,'/','G2'])
set_param([sys,'/','G2'],...
		'ForeGround',2,...
		'position',[415,367,435,393])

add_block('built-in/State-Space',[sys,'/','Plant'])
set_param([sys,'/','Plant'],...
		'Font Name','Times New Roman',...
		'A','Ap',...
		'B','Bp',...
		'C','Cp',...
		'D','Dp',...
		'X0','xp0',...
		'position',[300,295,385,335])
add_line(sys,[230,85;255,85])
add_line(sys,[95,85;155,85])
add_line(sys,[310,70;560,70])
add_line(sys,[310,95;420,95])
add_line(sys,[120,85;120,40;145,40])
add_line(sys,[115,185;95,185])
add_line(sys,[390,95;390,155;365,155])
add_line(sys,[430,445;410,445])
add_line(sys,[325,180;290,180])
add_line(sys,[525,15;555,15])
add_line(sys,[160,315;295,315])
add_line(sys,[120,85;120,130;185,130;185,160;155,160])
add_line(sys,[325,155;210,155;210,255;95,255;95,295;115,295])
add_line(sys,[115,160;55,160;55,315;115,315])
add_line(sys,[430,420;95,420;95,335;115,335])
add_line(sys,[260,315;260,380;305,380])
add_line(sys,[390,315;505,315])
add_line(sys,[230,420;230,245;285,245])
add_line(sys,[260,319;260,260;285,260])
add_line(sys,[630,290;655,290;655,180;365,180])
add_line(sys,[425,180;425,220;185,220;185,185;155,185])
add_line(sys,[655,290;655,435;470,435])
add_line(sys,[485,70;485,230;505,230])
add_line(sys,[545,330;565,330;565,300;590,300])
add_line(sys,[545,245;565,245;565,275;590,275])
add_line(sys,[405,315;405,335;430,335])
add_line(sys,[170,315;170,340;190,340])
add_line(sys,[320,255;340,255])
add_line(sys,[425,255;455,255])
add_line(sys,[485,255;505,255])
add_line(sys,[390,380;410,380])
add_line(sys,[440,380;475,380;475,340;505,340])

drawnow

% Return any arguments.
if (nargin | nargout)
	% Must use feval here to access system in memory
	if (nargin > 3)
		if (flag == 0)
			eval(['[ret,x0,str,ts,xts]=',sys,'(t,x,u,flag);'])
		else
			eval(['ret =', sys,'(t,x,u,flag);'])
		end
	else
		[ret,x0,str,ts,xts] = feval(sys);
	end
else
	drawnow % Flash up the model and execute load callback
end
